### Homo Sapiens clusters analysis

# pick homo sapiens (9606) proteins
mmseqs filtertaxseqdb /storage/martin/foldseek_cluster/afdb ./homo_sapiens/afdb_v3_human --taxon-list 9606 --threads 64

# extract homo sapiens containing clusters
awk 'FNR==1 {fn+=1;} fn==1 {id[$2]=1; next;} fn==2 && $2 in id {rep[$1]=1; next;} fn==3 && $1 in rep {print $0}' ./homo_sapiens/afdb_v3_human.index afdb50best_foldseek_clu_nofrag_nosingletons.tsv afdb50best_foldseek_clu_nofrag_nosingletons.tsv > homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human_index.tsv
awk 'FNR==1 {fn+=1;} fn==1 {id[$1]=1; next;} fn==2 && $2 in id {rep[$1]=1; next;} fn==3 && $1 in rep {print $0}' ./homo_sapiens/afdb_v3_human.index afdb50best_foldseek_clu_nofrag_nosingletons.tsv afdb50best_foldseek_clu_nofrag_nosingletons.tsv > homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human_index.tsv

# create homo sapiens clusters
mmseqs tsv2db homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human_index.tsv homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human

# repId-memId tsv file
mmseqs createtsv /storage/martin/foldseek_cluster/afdb /storage/martin/foldseek_cluster/afdb homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human.tsv

# LCA
mmseqs createsubdb ./homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human.index ./lca/afdb50best_foldseek_nofrag_nosingletons_lca ./homo_sapiens/human_containing_lca

# taxonomyreport
mmseqs taxonomyreport /storage/martin/foldseek_cluster/afdb50best ./homo_sapiens/human_containing_lca ./homo_sapiens/human_containing_lca.report

### GO data set up
awk '{gsub(";", "")} $1=="AC" { AC=$2} $1=="DR" && $2=="GO" {print AC"\t"$3} ' ../../cluster_analysis_old/pfam_pdb/uniprot_trembl.dat > ./go/accession_GO.tsv
awk ' !($1 in go) {go[$1] = $2} $1 in go {go[$1]=go[$1]";"$2}  END { for (key in go) print key"\t"go[key]}' ./go/accession_GO.tsv > ./go/accession_GO_semicolon.tsv

# find homo sapiens AFDB id
awk 'FNR==NR {id[$1]=1; next;} $1 in id {print $2}' homo_sapiens/afdb_v3_human.index homo_sapiens/afdb_v3_human.lookup > homo_sapiens/afdb_v3_human.ids

# map GO to human proteins
awk 'FNR==NR {id[$1]=1; next;} "AF-"$1"-F1-model_v3.cif" in id {print "AF-"$1"-F1-model_v3.cif\t"$2}' homo_sapiens/afdb_v3_human.ids go/accession_GO.tsv > homo_sapiens/human-sapId_GO.tsv

### pick the higher plddt sapiens protein in each cluster
# map plddt to homo sapiens AFDB proteins
awk 'FNR==NR {id[$1]=1; next;} $1 in id {print }' homo_sapiens/afdb_v3_human.ids plddt/entryId_plddt.tsv > homo_sapiens/human-sapId_plddt.tsv

# pick the highest plddt sapiens protein
awk 'FNR==NR {plddt[$1]=$2; next;} !($1 in id) {id[$1]=$2; highest[$1]=plddt[$2]; next;} ($1 in id) && plddt[$2]>highest[$1] {id[$1]=$2; highest[$1]=plddt[$2];} END {for (key in id) print key"\t"id[key]"\t"highest[key]}' homo_sapiens/human-sapId_plddt.tsv homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human.tsv > homo_sapiens/human-repId_highestSapId_plddt.tsv &

# map plddt and GO to highest Plddt sapiens protein
awk 'FNR==NR {id[$2]=$0; next;} $1 in id {print id[$1]"\t"$2}' homo_sapiens/human-repId_highestSapId_plddt.tsv homo_sapiens/human-sapId_GO.tsv > homo_sapiens/human-repId_highestSapId_sapPlddt_GO.tsv

# map lca rank info
awk -F "\t" 'FNR==NR {rep[$1]=$3; next;} $1 in rep {print $1"\t"rep[$1]"\t"$2"\t"$3"\t"$4}' lca/afdb50best_foldseek_clu_nofragments_nosingleton_lca.tsv homo_sapiens/human-repId_highestSapId_sapPlddt_GO.tsv > homo_sapiens/clu-sap-repId_rank_sapId_sapPlddt_sapGO.tsv
awk -F "\t" 'FNR==NR {rep[$1]=$4; next;} $1 in rep {print $1"\t"rep[$1]"\t"$2"\t"$3"\t"$4}' lca/afdb50best_foldseek_clu_nofragments_nosingleton_lca.tsv homo_sapiens/human-repId_highestSapId_sapPlddt_GO.tsv > homo_sapiens/clu-sap-repId_rankName_sapId_sapPlddt_sapGO.tsv

# annotate taxonomy to spaiens cluster members
awk 'FNR==NR {id[$2]=1; next;} $2 in id {print $0}' homo_sapiens/afdb50best_foldseek_clu_nofrag_nosingletons_containing_human.tsv taxonomy/afdb50best_clu_lineage.tsv > homo_sapiens/repId_memId_taxId_rank_rankName_lineage.tsv

